@page "/jobs/{jobId}/drawing"
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Job Drawing - Fencemark</PageTitle>

<div class="drawing-page">
    <div class="drawing-header">
        <div class="d-flex justify-content-between align-items-center p-3 bg-white border-bottom">
            <div>
                <h4 class="mb-0">
                    <i class="bi bi-map"></i> @jobName
                </h4>
                <small class="text-muted">Draw fence segments and place gates</small>
            </div>
            <div class="btn-toolbar gap-2">
                <div class="btn-group">
                    <button class="btn btn-outline-primary @(currentTool == "pan" ? "active" : "")" 
                            @onclick="@(() => SetTool("pan"))" title="Pan">
                        <i class="bi bi-arrows-move"></i>
                    </button>
                    <button class="btn btn-outline-primary @(currentTool == "draw" ? "active" : "")" 
                            @onclick="@(() => SetTool("draw"))" title="Draw Fence">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline-primary @(currentTool == "gate" ? "active" : "")" 
                            @onclick="@(() => SetTool("gate"))" title="Place Gate">
                        <i class="bi bi-door-open"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" @onclick="ToggleBoundaries" title="Toggle Lot Boundaries">
                        <i class="bi bi-bounding-box"></i> Boundaries
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ToggleSatellite" title="Toggle Satellite">
                        <i class="bi bi-globe"></i> @(showSatellite ? "Map" : "Satellite")
                    </button>
                </div>
                <button class="btn btn-success" @onclick="SaveDrawing">
                    <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-outline-secondary" @onclick="BackToJobs">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </div>

    <div class="drawing-container">
        <div class="map-sidebar">
            <div class="sidebar-section">
                <h6><i class="bi bi-layers"></i> Fence Segments</h6>
                <div class="segment-list">
                    @if (fenceSegments.Any())
                    {
                        @foreach (var segment in fenceSegments)
                        {
                            <div class="segment-item @(selectedSegmentId == segment.Id ? "selected" : "")" 
                                 @onclick="@(() => SelectSegment(segment.Id))">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>@(segment.Name ?? "Segment")</strong>
                                        <div class="small text-muted">
                                            @segment.LengthInFeet.ToString("F1") ft
                                            @if (segment.IsSnappedToBoundary)
                                            {
                                                <span class="badge bg-info ms-1">Snapped</span>
                                            }
                                            @if (segment.IsVerifiedOnsite)
                                            {
                                                <span class="badge bg-success ms-1">Verified</span>
                                            }
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="@(() => DeleteSegment(segment.Id))">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted small p-2">No fence segments drawn yet</div>
                    }
                </div>
            </div>

            <div class="sidebar-section mt-3">
                <h6><i class="bi bi-door-open"></i> Gates</h6>
                <div class="gate-list">
                    @if (gatePositions.Any())
                    {
                        @foreach (var gate in gatePositions)
                        {
                            <div class="gate-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>@(gate.Name ?? "Gate")</strong>
                                        <div class="small text-muted">
                                            @if (gate.IsVerifiedOnsite)
                                            {
                                                <span class="badge bg-success">Verified</span>
                                            }
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="@(() => DeleteGate(gate.Id))">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-muted small p-2">No gates placed yet</div>
                    }
                </div>
            </div>

            <div class="sidebar-section mt-3">
                <h6><i class="bi bi-info-circle"></i> Instructions</h6>
                <div class="small text-muted">
                    <p><strong>Draw Fence:</strong> Click points on the map to draw fence segments. Double-click to finish.</p>
                    <p><strong>Place Gate:</strong> Click on a fence segment to place a gate.</p>
                    <p><strong>Snap to Boundary:</strong> Fence lines will automatically snap to lot boundaries when close.</p>
                </div>
            </div>
        </div>

        <div id="map" class="map-canvas"></div>
    </div>
</div>

<style>
    .drawing-page {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        flex-direction: column;
    }

    .drawing-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .map-sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        padding: 1rem;
    }

    .sidebar-section {
        margin-bottom: 1rem;
    }

    .sidebar-section h6 {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }

    .segment-list, .gate-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .segment-item, .gate-item {
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .segment-item:hover, .gate-item:hover {
        background-color: #f8f9fa;
        border-color: #667eea;
    }

    .segment-item.selected {
        background-color: #e7f3ff;
        border-color: #667eea;
    }

    .map-canvas {
        flex: 1;
        position: relative;
    }

    .btn-toolbar {
        display: flex;
        align-items: center;
    }
</style>

@code {
    [Parameter]
    public string JobId { get; set; } = string.Empty;

    private string jobName = "Job Drawing";
    private string currentTool = "pan";
    private bool showSatellite = true;
    private bool showBoundaries = true;
    private string? selectedSegmentId = null;

    private List<FenceSegmentDto> fenceSegments = new();
    private List<GatePositionDto> gatePositions = new();

    protected override async Task OnInitializedAsync()
    {
        // Load job details
        await LoadJobDetails();
        
        // Load existing fence segments and gates
        await LoadFenceSegments();
        await LoadGatePositions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Initialize Azure Maps
            await JSRuntime.InvokeVoidAsync("initializeAzureMap", JobId);
        }
    }

    private async Task LoadJobDetails()
    {
        // TODO: Load job details from API
        jobName = $"Job Drawing - {JobId}";
    }

    private async Task LoadFenceSegments()
    {
        // TODO: Load fence segments from API
        // var segments = await FenceSegmentClient.GetByJobAsync(JobId);
        // fenceSegments = segments.ToList();
    }

    private async Task LoadGatePositions()
    {
        // TODO: Load gate positions from API
        // var gates = await GatePositionClient.GetByJobAsync(JobId);
        // gatePositions = gates.ToList();
    }

    private async Task SetTool(string tool)
    {
        currentTool = tool;
        await JSRuntime.InvokeVoidAsync("setDrawingTool", tool);
    }

    private async Task ToggleSatellite()
    {
        showSatellite = !showSatellite;
        await JSRuntime.InvokeVoidAsync("toggleMapLayer", "satellite", showSatellite);
    }

    private async Task ToggleBoundaries()
    {
        showBoundaries = !showBoundaries;
        await JSRuntime.InvokeVoidAsync("toggleMapLayer", "boundaries", showBoundaries);
    }

    private void SelectSegment(string segmentId)
    {
        selectedSegmentId = selectedSegmentId == segmentId ? null : segmentId;
    }

    private async Task DeleteSegment(string segmentId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this fence segment?"))
        {
            // TODO: Delete from API
            // await FenceSegmentClient.DeleteAsync(segmentId);
            fenceSegments.RemoveAll(s => s.Id == segmentId);
            await JSRuntime.InvokeVoidAsync("removeSegmentFromMap", segmentId);
        }
    }

    private async Task DeleteGate(string gateId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this gate?"))
        {
            // TODO: Delete from API
            // await GatePositionClient.DeleteAsync(gateId);
            gatePositions.RemoveAll(g => g.Id == gateId);
            await JSRuntime.InvokeVoidAsync("removeGateFromMap", gateId);
        }
    }

    private async Task SaveDrawing()
    {
        // Get all drawn segments and gates from the map
        var mapData = await JSRuntime.InvokeAsync<string>("getMapData");
        
        // TODO: Save to API
        // await FenceSegmentClient.SaveAllAsync(JobId, mapData);
        
        // Show success message
        await JSRuntime.InvokeVoidAsync("alert", "Drawing saved successfully!");
    }

    private void BackToJobs()
    {
        Navigation.NavigateTo("/jobs");
    }

    // DTOs for fence segments and gates
    private class FenceSegmentDto
    {
        public string Id { get; set; } = string.Empty;
        public string? Name { get; set; }
        public decimal LengthInFeet { get; set; }
        public bool IsSnappedToBoundary { get; set; }
        public bool IsVerifiedOnsite { get; set; }
    }

    private class GatePositionDto
    {
        public string Id { get; set; } = string.Empty;
        public string? Name { get; set; }
        public bool IsVerifiedOnsite { get; set; }
    }
}
