# ============================================================================
# Azure Deployment Workflow
# ============================================================================
# This workflow deploys the Fencemark application to Azure Container Apps
# using Bicep infrastructure as code.
#
# Deployment Flow:
#   1. Build and test the solution
#   2. Publish application artifacts
#   3. Deploy Bicep infrastructure to Azure
#   4. Build and push Docker images to Azure Container Registry
#   5. Update Container Apps with new images
#
# Environments:
#   - dev: Auto-deploys on push to main
#   - staging: Manual deployment with approval
#   - prod: Manual deployment with approval
#
# Authentication: Uses OpenID Connect (OIDC) for secure, credential-less auth
#
# For more information, see: CI-CD.md
# ============================================================================

name: Deploy to Azure

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-${{ github.ref }}-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

permissions:
  id-token: write       # Required for OIDC authentication with Azure
  checks: write         # Write check run results
  pull-requests: write  # Comment deployment status on PRs
  contents: read        # Read repository contents
  packages: write       # Push container images to ACR

env:
  AZURE_LOCATION: 'australiaeast'
  DOTNET_VERSION: '10.0.x'

jobs:
  # ============================================================================
  # Build and Test Job
  # ============================================================================
  # Builds the solution, runs tests, and publishes artifacts for deployment.
  # Artifacts are retained for 1 day to support multiple environment deployments.
  # ============================================================================
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release --report-xunit-trx --results-directory TestResults

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/*.trx
          if-no-files-found: warn
          retention-days: 30

      - name: Annotate test failures
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: dotnet-tests
          path: TestResults/*.trx
          reporter: dotnet-trx
          fail-on-error: false

      - name: Generate image metadata
        id: meta
        run: |
          echo "tags=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "short-sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Publish API Service
        run: dotnet publish fencemark.ApiService/fencemark.ApiService.csproj -c Release -o ./publish/apiservice --no-build

      - name: Publish Web Frontend
        run: dotnet publish fencemark.Web/fencemark.Web.csproj -c Release -o ./publish/webfrontend --no-build

      - name: Publish Blazor WASM
        run: dotnet publish fencemark.Client/fencemark.Client.csproj -c Release -o ./publish/blazor-wasm --no-build

      - name: Upload API Service artifact
        uses: actions/upload-artifact@v4
        with:
          name: apiservice-publish
          path: ./publish/apiservice
          retention-days: 1

      - name: Upload Blazor WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: blazor-wasm-publish
          path: ./publish/blazor-wasm
          retention-days: 1

  # ============================================================================
  # Deploy Central App Configuration
  # ============================================================================
  # Deploys the centralized App Configuration store that serves all environments.
  # This is deployed once and shared across dev, staging, and prod using labels.
  # Uses a conditional check to avoid redeploying if it already exists.
  # ============================================================================
  deploy-central-config:
    name: Deploy Central App Config
    environment: dev
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Central App Configuration
        uses: azure/bicep-deploy@v2
        with:
          type: deployment
          operation: create
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          location: ${{ env.AZURE_LOCATION }}
          template-file: ./infra/central-appconfig.bicep
          parameters-file: ./infra/central-appconfig.bicepparam

      - name: Verify Central App Configuration exists
        run: |
          az appconfig show --name appcs-fencemark --resource-group rg-fencemark-central-config

  # ============================================================================
  # Deploy to Dev Environment
  # ============================================================================
  deploy-dev:
    name: Deploy to Dev
    needs: [build, deploy-central-config]
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    uses: ./.github/workflows/deploy-environment.yml
    with:
      environment: dev
      azure-location: australiaeast
      run-health-checks: true
    secrets:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

  # ============================================================================
  # E2E Tests with Playwright (Dev)
  # ============================================================================
  e2e-tests-dev:
    name: E2E Tests (Dev)
    needs: deploy-dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Get Key Vault name
        id: get-keyvault
        run: |
          # Get Key Vault name from deployment outputs or use default
          KV_NAME="kv-ciambfwyw65gna5lu"
          echo "keyvault-name=$KV_NAME" >> $GITHUB_OUTPUT
          echo "Key Vault: $KV_NAME"

      - name: Get test user credentials from Key Vault
        id: get-test-creds
        run: |
          KV_NAME="${{ steps.get-keyvault.outputs.keyvault-name }}"
          
          # Get test user email
          TEST_EMAIL=$(az keyvault secret show --vault-name $KV_NAME --name test-user-email --query value -o tsv)
          echo "test-email=$TEST_EMAIL" >> $GITHUB_OUTPUT
          echo "Test user email retrieved: $TEST_EMAIL"
          
          # Get test user password (masked in output)
          TEST_PASSWORD=$(az keyvault secret show --vault-name $KV_NAME --name test-user-password --query value -o tsv)
          echo "::add-mask::$TEST_PASSWORD"
          echo "test-password=$TEST_PASSWORD" >> $GITHUB_OUTPUT
          echo "Test user password retrieved (masked)"

      - name: Setup .NET for E2E tests
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Playwright browsers
        run: |
          dotnet build fencemark.Tests/fencemark.Tests.csproj
          pwsh fencemark.Tests/bin/Debug/net10.0/playwright.ps1 install chromium

      - name: Run E2E Playwright tests
        id: e2e-tests
        continue-on-error: true
        env:
          TEST_BASE_URL: ${{ needs.deploy-dev.outputs.web-frontend-url }}
          TEST_USER_EMAIL: ${{ steps.get-test-creds.outputs.test-email }}
          TEST_USER_PASSWORD: ${{ steps.get-test-creds.outputs.test-password }}
          TEST_HEADLESS: "true"
        run: |
          # Run the Web UI E2E tests - they will skip gracefully if credentials are missing
          dotnet test --project fencemark.Tests/fencemark.Tests.csproj \
            --filter-class "fencemark.Tests.E2E.WebUIE2ETests" \
            --report-xunit-trx --results-directory TestResults/playwright

      - name: Upload Playwright artifacts on failure
        if: steps.e2e-tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts-dev
          path: |
            fencemark.Tests/screenshots/
          if-no-files-found: ignore
          retention-days: 7


      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/playwright/*.trx
          overwrite: true
          if-no-files-found: warn
          retention-days: 30


      - name: Annotate test failures
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: e2e-playwright-tests
          path: TestResults/playwright/*.trx
          reporter: dotnet-trx
          fail-on-error: false

  # ============================================================================
  # Deploy to Staging Environment
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    needs: [build, deploy-central-config]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    uses: ./.github/workflows/deploy-environment.yml
    with:
      environment: staging
      azure-location: australiaeast
      run-health-checks: true
    secrets:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

  # ============================================================================
  # Deploy to Production Environment
  # ============================================================================
  deploy-prod:
    name: Deploy to Production
    needs: [build, deploy-central-config]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    uses: ./.github/workflows/deploy-environment.yml
    with:
      environment: prod
      azure-location: australiaeast
      run-health-checks: true
    secrets:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
