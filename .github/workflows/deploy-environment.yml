# ============================================================================
# Reusable Environment Deployment Workflow
# ============================================================================
# This reusable workflow deploys the Fencemark application to a specified
# Azure environment (dev, staging, or prod).
#
# It handles:
#   1. Infrastructure provisioning with Bicep
#   2. Building and pushing Docker images to ACR
#   3. Deploying Container Apps
#   4. Health checks and smoke tests
#
# Called by: deploy.yml
# ============================================================================

name: Deploy Environment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev, staging, prod)'
        required: true
        type: string
      azure-location:
        description: 'Azure region for deployment'
        required: false
        type: string
        default: 'australiaeast'
      run-health-checks:
        description: 'Run health checks after deployment'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
    outputs:
      resource-group:
        description: 'Resource group name'
        value: ${{ jobs.deploy.outputs.resource-group }}
      web-frontend-url:
        description: 'Web frontend URL'
        value: ${{ jobs.deploy.outputs.web-frontend-url }}
      api-image:
        description: 'API Service image tag'
        value: ${{ jobs.deploy.outputs.api-image }}

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ inputs.environment }}
    outputs:
      resource-group: ${{ steps.get-outputs.outputs.resource-group }}
      web-frontend-url: ${{ steps.get-outputs.outputs.web-frontend-url }}
      api-image: ${{ env.API_IMAGE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Service Principal Object ID
        id: get-principal-id
        run: |
          PRINCIPAL_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
          echo "principal-id=$PRINCIPAL_ID" >> $GITHUB_OUTPUT

      - name: Deploy Bicep infrastructure
        uses: azure/bicep-deploy@v2
        id: deploy-infra
        with:
          type: deployment
          operation: create
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          location: ${{ inputs.azure-location }}
          template-file: ./infra/main.bicep
          parameters-file: ./infra/${{ inputs.environment }}.bicepparam
          

      - name: Get deployment outputs
        id: get-outputs
        run: |
          echo "acr-name=${{ steps.deploy-infra.outputs.containerRegistryName }}" >> $GITHUB_OUTPUT
          echo "acr-login-server=${{ steps.deploy-infra.outputs.containerRegistryLoginServer }}" >> $GITHUB_OUTPUT
          echo "api-service-name=${{ steps.deploy-infra.outputs.apiServiceName }}" >> $GITHUB_OUTPUT
          echo "web-frontend-name=${{ steps.deploy-infra.outputs.webFrontendName }}" >> $GITHUB_OUTPUT
          echo "resource-group=${{ steps.deploy-infra.outputs.resourceGroupName }}" >> $GITHUB_OUTPUT
          echo "web-frontend-url=${{ steps.deploy-infra.outputs.webFrontendUrl }}" >> $GITHUB_OUTPUT
          echo "static-web-app-custom-domain=${{ steps.deploy-infra.outputs.staticWebAppCustomDomain }}" >> $GITHUB_OUTPUT
          echo "static-web-app-name=${{ steps.deploy-infra.outputs.staticWebAppName }}" >> $GITHUB_OUTPUT
          echo "static-web-app-token=${{ steps.deploy-infra.outputs.staticWebAppDeploymentToken }}" >> $GITHUB_OUTPUT

      - name: Download API Service artifact
        uses: actions/download-artifact@v4
        with:
          name: apiservice-publish
          path: ./publish/apiservice

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ steps.get-outputs.outputs.acr-name }}

      - name: Build and push API Service image
        run: |
          IMAGE_TAG="${{ steps.get-outputs.outputs.acr-login-server }}/apiservice:${{ github.sha }}"
          docker build -t $IMAGE_TAG -f fencemark.ApiService/Dockerfile ./publish/apiservice
          docker push $IMAGE_TAG
          echo "API_IMAGE=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy API Service to Container App
        run: |
          az containerapp update \
            --name ${{ steps.get-outputs.outputs.api-service-name }} \
            --resource-group ${{ steps.get-outputs.outputs.resource-group }} \
            --image ${{ env.API_IMAGE }}

      - name: Wait for deployment to stabilize
        run: sleep 30

      # ============================================================================
      # Deploy Static Web App
      # ============================================================================

      - name: Download Blazor WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: blazor-wasm-publish
          path: ./publish/blazor-wasm
          
      - name: Combine Appsettings Files for environment
        uses: Afterlife-Guide/AppSettings.Merge@0.1.3.4
        with:
          app-environment: ${{ inputs.environment }}
          path: '/publish/blazor-wasm/wwwroot/'

      - name: Deploy to Static Web App
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.get-outputs.outputs.static-web-app-token }}
          action: 'upload'
          app_location: 'publish/blazor-wasm/wwwroot'
          skip_app_build: true
          skip_api_build: true

      # ============================================================================
      # Health Checks
      # ============================================================================

      - name: Health Check - Web Frontend
        id: health-check-web
        if: inputs.run-health-checks
        continue-on-error: true
        run: |
          CUSTOM_DOMAIN="${{ steps.get-outputs.outputs.static-web-app-custom-domain }}"
          DEFAULT_URL="${{ steps.get-outputs.outputs.web-frontend-url }}"
          
          # Prefer custom domain if available; build URL with https if needed
          if [ -n "$CUSTOM_DOMAIN" ]; then
            if [[ "$CUSTOM_DOMAIN" =~ ^https?:// ]]; then
              PRIMARY_URL="$CUSTOM_DOMAIN"
            else
              PRIMARY_URL="https://$CUSTOM_DOMAIN"
            fi
            FALLBACK_URL="$DEFAULT_URL"
            echo "Using custom domain for health check: $PRIMARY_URL (fallback: $FALLBACK_URL)"
          else
            PRIMARY_URL="$DEFAULT_URL"
            FALLBACK_URL=""
            echo "No custom domain configured; using default URL: $PRIMARY_URL"
          fi

          # Try health check on primary URL with retries
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PRIMARY_URL"/health || echo "000")
            echo "Health check (primary) attempt $((RETRY_COUNT + 1)): HTTP $HTTP_CODE"
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Web Frontend health check passed (primary)"
              echo "status=success" >> $GITHUB_OUTPUT
              echo "used-fallback=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 10
            fi
          done

          # Fallback to default hostname if primary failed
          if [ -n "$FALLBACK_URL" ]; then
            echo "Primary health check failed; falling back to default hostname: $FALLBACK_URL"
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FALLBACK_URL"/health || echo "000")
              echo "Health check (fallback) attempt $((RETRY_COUNT + 1)): HTTP $HTTP_CODE"
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Web Frontend health check passed (fallback)"
                echo "status=success" >> $GITHUB_OUTPUT
                echo "used-fallback=true" >> $GITHUB_OUTPUT
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                sleep 10
              fi
            done
          fi

          echo "âŒ Web Frontend health check failed after $MAX_RETRIES attempts (primary${FALLBACK_URL:+ and fallback})"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "used-fallback=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Smoke Test - Home Page Accessibility
        id: smoke-test-home
        if: inputs.run-health-checks && steps.health-check-web.outputs.status == 'success'
        continue-on-error: true
        run: |
          CUSTOM_DOMAIN="${{ steps.get-outputs.outputs.static-web-app-custom-domain }}"
          DEFAULT_URL="${{ steps.get-outputs.outputs.web-frontend-url }}"
          
          if [ -n "$CUSTOM_DOMAIN" ]; then
            if [[ "$CUSTOM_DOMAIN" =~ ^https?:// ]]; then
              PRIMARY_URL="$CUSTOM_DOMAIN"
            else
              PRIMARY_URL="https://$CUSTOM_DOMAIN"
            fi
            FALLBACK_URL="$DEFAULT_URL"
          else
            PRIMARY_URL="$DEFAULT_URL"
            FALLBACK_URL=""
          fi

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$PRIMARY_URL" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Home page is accessible at $PRIMARY_URL"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ -n "$FALLBACK_URL" ]; then
            echo "Primary home page check failed (HTTP $HTTP_CODE); trying fallback $FALLBACK_URL"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FALLBACK_URL" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Home page is accessible at fallback $FALLBACK_URL"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Home page returned HTTP $HTTP_CODE on fallback"
              echo "status=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "âŒ Home page returned HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report Health Check Status
        if: always() && inputs.run-health-checks
        run: |
          echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.health-check-web.outputs.status }}" = "success" ]; then
            echo "âœ… **Web Frontend:** Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Web Frontend:** Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.smoke-test-home.outputs.status }}" = "success" ]; then
            echo "âœ… **Smoke Test:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.smoke-test-home.outputs.status }}" = "failed" ]; then
            echo "âŒ **Smoke Test:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Smoke Test:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ ${{ inputs.environment }} Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ inputs.azure-location }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.get-outputs.outputs.resource-group }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "- **API Service:** \`${{ env.API_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Application URL" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.get-outputs.outputs.web-frontend-url }}" >> $GITHUB_STEP_SUMMARY
