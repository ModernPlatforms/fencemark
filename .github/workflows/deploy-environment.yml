# ============================================================================
# Reusable Environment Deployment Workflow
# ============================================================================
# This reusable workflow deploys the Fencemark application to a specified
# Azure environment (dev, staging, or prod).
#
# It handles:
#   1. Infrastructure provisioning with Bicep
#   2. Building and pushing Docker images to ACR
#   3. Deploying Container Apps
#   4. Health checks and smoke tests
#
# Called by: deploy.yml
# ============================================================================

name: Deploy Environment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev, staging, prod)'
        required: true
        type: string
      azure-location:
        description: 'Azure region for deployment'
        required: false
        type: string
        default: 'australiaeast'
      run-health-checks:
        description: 'Run health checks after deployment'
        required: false
        type: boolean
        default: true
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
    outputs:
      resource-group:
        description: 'Resource group name'
        value: ${{ jobs.deploy.outputs.resource-group }}
      web-frontend-url:
        description: 'Web frontend URL'
        value: ${{ jobs.deploy.outputs.web-frontend-url }}
      api-image:
        description: 'API Service image tag'
        value: ${{ jobs.deploy.outputs.api-image }}

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment: ${{ inputs.environment }}
    outputs:
      resource-group: ${{ steps.get-outputs.outputs.resource-group }}
      web-frontend-url: ${{ steps.get-outputs.outputs.web-frontend-url }}
      api-image: ${{ env.API_IMAGE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Service Principal Object ID
        id: get-principal-id
        run: |
          PRINCIPAL_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
          echo "principal-id=$PRINCIPAL_ID" >> $GITHUB_OUTPUT

      - name: Deploy Bicep infrastructure
        uses: azure/bicep-deploy@v2
        id: deploy-infra
        with:
          type: deployment
          operation: create
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          scope: subscription
          location: ${{ inputs.azure-location }}
          template-file: ./infra/main.bicep
          parameters-file: ./infra/${{ inputs.environment }}.bicepparam
          parameters: '{"githubActionsPrincipalId": "${{ steps.get-principal-id.outputs.principal-id }}"}'

      - name: Get deployment outputs
        id: get-outputs
        run: |
          echo "acr-name=${{ steps.deploy-infra.outputs.containerRegistryName }}" >> $GITHUB_OUTPUT
          echo "acr-login-server=${{ steps.deploy-infra.outputs.containerRegistryLoginServer }}" >> $GITHUB_OUTPUT
          echo "api-service-name=${{ steps.deploy-infra.outputs.apiServiceName }}" >> $GITHUB_OUTPUT
          echo "web-frontend-name=${{ steps.deploy-infra.outputs.webFrontendName }}" >> $GITHUB_OUTPUT
          echo "resource-group=${{ steps.deploy-infra.outputs.resourceGroupName }}" >> $GITHUB_OUTPUT
          echo "web-frontend-url=${{ steps.deploy-infra.outputs.webFrontendUrl }}" >> $GITHUB_OUTPUT
          echo "storage-account=${{ steps.deploy-infra.outputs.staticSiteStorageAccountName }}" >> $GITHUB_OUTPUT

      - name: Download API Service artifact
        uses: actions/download-artifact@v4
        with:
          name: apiservice-publish
          path: ./publish/apiservice

      - name: Log in to Azure Container Registry
        run: az acr login --name ${{ steps.get-outputs.outputs.acr-name }}

      - name: Build and push API Service image
        run: |
          IMAGE_TAG="${{ steps.get-outputs.outputs.acr-login-server }}/apiservice:${{ github.sha }}"
          docker build -t $IMAGE_TAG -f fencemark.ApiService/Dockerfile ./publish/apiservice
          docker push $IMAGE_TAG
          echo "API_IMAGE=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy API Service to Container App
        run: |
          az containerapp update \
            --name ${{ steps.get-outputs.outputs.api-service-name }} \
            --resource-group ${{ steps.get-outputs.outputs.resource-group }} \
            --image ${{ env.API_IMAGE }}

      - name: Wait for deployment to stabilize
        run: sleep 30

      # ============================================================================
      # Deploy Static Web App
      # ============================================================================

      - name: Download Blazor WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: blazor-wasm-publish
          path: ./publish/blazor-wasm

      - name: Update Blazor WASM appsettings for environment
        run: |
          # Set environment-specific configuration
          case "${{ inputs.environment }}" in
            dev)
              AUTHORITY="https://devfencemark.ciamlogin.com/"
              API_URL="https://ca-fencemark-api-dev.azurecontainerapps.io"
              ;;
            staging)
              AUTHORITY="https://stagingfencemark.ciamlogin.com/"
              API_URL="https://ca-fencemark-api-staging.azurecontainerapps.io"
              ;;
            prod)
              AUTHORITY="https://fencemark.ciamlogin.com/"
              API_URL="https://api.fencemark.com"
              ;;
          esac

          # Use the same AZURE_CLIENT_ID for all environments
          CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}"

          cat > publish/blazor-wasm/wwwroot/appsettings.json <<EOF
          {
            "AzureAd": {
              "Authority": "$AUTHORITY",
              "ClientId": "$CLIENT_ID",
              "ValidateAuthority": true,
              "ApiScope": "api://$CLIENT_ID/access_as_user"
            },
            "ApiBaseUrl": "$API_URL"
          }
          EOF

      - name: Enable Static Website Hosting
        run: |
          # Use storage account name from Bicep outputs
          STORAGE_ACCOUNT="${{ steps.get-outputs.outputs.storage-account }}"
          
          # Enable static website hosting
          az storage blob service-properties update \
            --account-name $STORAGE_ACCOUNT \
            --static-website \
            --index-document index.html \
            --404-document index.html \
            --auth-mode login

      - name: Deploy to Storage Account Static Website
        run: |
          # Use storage account name from Bicep outputs
          STORAGE_ACCOUNT="${{ steps.get-outputs.outputs.storage-account }}"
          
          # Upload to $web container (static website hosting)
          az storage blob upload-batch \
            --account-name $STORAGE_ACCOUNT \
            --source publish/blazor-wasm/wwwroot \
            --destination '$web' \
            --auth-mode login \
            --overwrite

      # ============================================================================
      # Health Checks
      # ============================================================================

      - name: Health Check - Web Frontend
        id: health-check-web
        if: inputs.run-health-checks
        continue-on-error: true
        run: |
          WEB_URL="${{ steps.get-outputs.outputs.web-frontend-url }}"
          echo "Web URL: $WEB_URL"
          
          # Try health check endpoint with retries
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $WEB_URL/health || echo "000")
            echo "Health check attempt $((RETRY_COUNT + 1)): HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Web Frontend health check passed"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 10
            fi
          done
          
          echo "âŒ Web Frontend health check failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Smoke Test - Home Page Accessibility
        id: smoke-test-home
        if: inputs.run-health-checks && steps.health-check-web.outputs.status == 'success'
        continue-on-error: true
        run: |
          WEB_URL="${{ steps.get-outputs.outputs.web-frontend-url }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $WEB_URL || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Home page is accessible"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Home page returned HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report Health Check Status
        if: always() && inputs.run-health-checks
        run: |
          echo "## ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.health-check-web.outputs.status }}" = "success" ]; then
            echo "âœ… **Web Frontend:** Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Web Frontend:** Unhealthy" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.smoke-test-home.outputs.status }}" = "success" ]; then
            echo "âœ… **Smoke Test:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.smoke-test-home.outputs.status }}" = "failed" ]; then
            echo "âŒ **Smoke Test:** Failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Smoke Test:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ ${{ inputs.environment }} Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ inputs.azure-location }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resource Group:** ${{ steps.get-outputs.outputs.resource-group }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Container Images" >> $GITHUB_STEP_SUMMARY
          echo "- **API Service:** \`${{ env.API_IMAGE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Application URL" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.get-outputs.outputs.web-frontend-url }}" >> $GITHUB_STEP_SUMMARY
